# Creates an Azure SQL Server

Creates an Azure SQL Server with:

* SQL Server
* SQL Server Elastic pool
* SQL Server Administrator
* SQL Server Azure AD Administrators
* Attach SQL Server to virtual network
* Diagnostics logging for SQL Server


Reference the module to a specific version (recommended):
```hcl
module "sql_server" {
    source  = "aztfmod/caf-sql-server/azurerm"
    version = "0.x.y"

    prefix                      = local.prefix
    tags                        = local.tags
    convention                  = local.convention

    resource_group_name         = azurerm_resource_group.rg_test.name
    location                    = local.location
    sql_server                  = local.sql_server
    subnet_id                   = local.subnet_id
    aad_admin                   = local.aad_admin

    diagnostics_map             = module.diags_test.diagnostics_map
    log_analytics_workspace     = module.la_test
    diagnostics_settings        = local.diagnostics
}
```

## Inputs 

| Name | Type | Default | Description |
| -- | -- | -- | -- |
| resource_group_name | string | None | (Required) Name of the resource group where to create the resource. Changing this forces a new resource to be created. |
| location | string | None | (Required) Specifies the Azure location to deploy the resource. Changing this forces a new resource to be created.  |
| tags | map | None | (Required) Map of tags for the deployment.  |
| log_analytics_workspace | string | None | (Required) Log Analytics Workspace. |
| diagnostics_map | map | None | (Required) Map with the diagnostics repository information.  |
| diagnostics_settings | object | None | (Required) Map with the diagnostics settings. See the required structure in the following example or in the diagnostics module documentation. |
| convention | string | None | (Required) Naming convention to be used (check at the naming convention module for possible values).  |
| prefix | string | None | (Optional) Prefix to be used. |
| postfix | string | None | (Optional) Postfix to be used. |
| max_length | string | None | (Optional) maximum length to the name of the resource. |
| sql_server | object | None | (Required) SQL Server Configuration object (see details below). |
| subnet_id | string | None | (Optional) Subnet identifier for the resource to be created |
| aad_admin | object | None | (Optional) Azure AD object to use as SQL Server administrator |


## Parameters

### sql_server
(Required) SQL Server configuration object, and SQL Elastic Pool configuration settings.

```hcl
variable "sql_server"{
    description = "(Required) SQL Server Configuration object"
    # type = object
    # ({
    #     name    = string
    #     version = string
    #     admin   = string
    #
    #     #optional fields
    #     password = string ##if not specified, password will be generated by random
    #     connection_policy = string
    #     extended_auditing_policy = object({
    #         storage_account_access_key  = string
    #         storage_endpoint            = string
    #         retention_in_days           = number
    #     })
    #     elastic_pool = object({
    #         name                = string
    #         edition             = string
    #         dtu                 = number
    #         db_dtu_min          = number
    #         db_dtu_max          = number
    #         pool_size           = number
    #     })
    # })
    
}
```

Example

```hcl
sql_server = {
        name = "caf_sql_test"
        version = "12.0"
        admin = "test"
        extended_auditing_policy = {
            storage_account_access_key  = data.azurerm_storage_account.diagnostics_storage.primary_access_key
            storage_endpoint            = data.azurerm_storage_account.diagnostics_storage.primary_blob_endpoint
            retention_in_days           = 60
        }
        elastic_pool = {
            name                = "mypool"
            edition             = "Basic"
            dtu                 = 50
            db_dtu_min          = 0
            db_dtu_max          = 5
            pool_size           = 5000
        }
    }
```

### aad_admin

(Optional) Object containing the Azure AD for the SQL Server admin account

```hcl
variable "aad_admin"{
    description = "(Optional) Object containing the Azure AD for the SQL Server admin account"
    # type = object({
    #     name        = string #The login name of the principal to set as the server administrator
    #     id          = string #The ID of the principal to set as the server administrator
    #     tenant_id   = string #The Azure Tenant ID
    # })
}
```

Example

```hcl
aad_admin = {
        name        = "sqladmin"
        tenant_id   = data.azurerm_client_config.current.tenant_id
        id          = data.azurerm_client_config.current.client_id
    }
```

### diagnostics_settings
(Required) Map with the diagnostics settings for object to be deployed.
See the required structure in the following example or in the diagnostics module documentation.

```hcl
variable "diagnostics_settings" {
 description = "(Required) Map with the diagnostics settings for public virtual network deployment"
}
```

Example

```hcl
diagnostics_settings = {
    log = [
                # ["Category name",  "Diagnostics Enabled(true/false)", "Retention Enabled(true/false)", Retention_period]
                ["VMProtectionAlerts", true, true, 60],
        ]
    metric = [
                #["Category name",  "Diagnostics Enabled(true/false)", "Retention Enabled(true/false)", Retention_period]
                  ["AllMetrics", true, true, 60],
    ]
}
```


## Output

| Name | Type | Description |
| -- | -- | -- |
| object | object(sensitive) | Returns the full object of the created SQL Server |
| name | string | Returns the name of the created SQL Server |
| id | string | Returns the ID of the created SQL Server | 
| password | string(sensitive) | Value of the administrative password of the SQL Server - Recommended to get this output and store in AKV|